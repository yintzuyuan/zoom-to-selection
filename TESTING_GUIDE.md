# Zoom to Selection 外掛測試指南

## 功能改進說明

本次更新改進了文字選取模式下的跨行處理邏輯：

### 主要改進

1. **Y 座標變化檢測跨行**：
   - 自動檢測選取範圍是否跨越多行
   - 閾值設定：字形高度的 30%，最少 50 單位

2. **跨行時使用 editViewWidth**：
   - 跨行選取時，自動使用編輯器行寬作為縮放寬度
   - 確保所有選取內容都包含在可視範圍內

3. **單行模式優化**：
   - 比較簡化計算和累積寬度計算
   - 自動選擇最準確的方法
   - 驗證 `bounds.origin.x` 的座標性質

4. **詳細除錯輸出**：
   - 完整的計算過程記錄
   - 便於追蹤和驗證計算邏輯

## 測試步驟

### 準備工作

1. 在 Glyphs 中開啟測試字型檔案
2. 開啟 Macro Panel（Window > Macro Panel）查看 console 輸出
3. 確保外掛已安裝並啟用

### 測試場景 1：單行文字選取

**目標**：驗證單行選取的基本功能

1. 在 Edit View 中切換到 Text Tool（快捷鍵 `T`）
2. 輸入單行文字，例如：`Hamburgerfonts`
3. 選取部分文字，例如：`burger`
4. 執行外掛縮放功能

**預期結果**：
- Console 顯示「✓ 單行選取」
- 顯示簡化計算和累積計算的對比
- 選取的文字正確縮放到畫面中央
- 如果兩種計算方法差異小於 1.0，使用簡化計算

**檢查項目**：
```
📦 收集有效邊界:
   [0] b: bounds.origin=(x, y), size=(w, h), layer.width=...

🔍 檢測是否跨行:
   Y 座標範圍: ... (差距=...)
   判定: ✓ 單行選取

📏 單行模式計算:
   第一個字形: b
     bounds.origin.x = ...
   最後一個字形: r
     bounds.origin.x = ...
   簡化計算: min_x=..., max_x=..., width=...
   累積計算: min_x=..., max_x=..., width=...
   寬度差異: ...
   → 使用簡化計算（差異可忽略）或
   → 使用累積計算（差異顯著，bounds 可能是相對座標）
```

### 測試場景 2：跨兩行文字選取

**目標**：驗證跨行檢測和 editViewWidth 使用

1. 在 Edit View 中輸入較長的文字，使其自動換行
   - 例如：`The quick brown fox jumps over the lazy dog`
2. 選取跨越兩行的文字範圍
   - 例如：從第一行末尾的 `jumps` 到第二行開頭的 `over`
3. 執行外掛縮放功能

**預期結果**：
- Console 顯示「✓ 跨行選取」
- 使用 `Glyphs.editViewWidth` 作為寬度
- 畫面縮放到完整的編輯器行寬
- Y 範圍涵蓋兩行的所有內容

**檢查項目**：
```
🔍 檢測是否跨行:
   Y 座標範圍: ... (差距=...)
   參考字形高度: ..., 閾值: ...
   判定: ✓ 跨行選取

📐 跨行模式計算:
   editViewWidth = ...
   使用寬度: ... (editViewWidth)
   Y 範圍: ... ~ ... (高度=...)
```

### 測試場景 3：多行完整選取

**目標**：驗證多行選取的穩定性

1. 在 Edit View 中輸入多行文字（3-4 行）
2. 選取完整的多行範圍
3. 執行外掛縮放功能

**預期結果**：
- 檢測為跨行選取
- 使用 editViewWidth 作為寬度
- Y 範圍涵蓋所有選取的行

### 測試場景 4：包含空白字符的選取

**目標**：驗證空白字符的處理

1. 選取包含空白（space）的文字範圍
2. 執行外掛縮放功能

**預期結果**：
- 空白字符可能沒有 bounds，但不影響計算
- Console 可能顯示「⚠️ 無效或缺少 bounds」
- 最終縮放結果仍然正確

### 測試場景 5：節點選取模式（回歸測試）

**目標**：確保改動不影響原有的節點選取功能

1. 切換到 Select Tool（快捷鍵 `V`）
2. 選取一些節點或路徑
3. 執行外掛縮放功能

**預期結果**：
- 節點選取模式仍正常工作
- 使用 `_calculateNodeSelectionBounds()` 函數
- 縮放結果正確

## 觀察重點

### 座標性質驗證

觀察 Console 中「單行模式計算」部分的輸出：

1. **如果「寬度差異」< 1.0**：
   - 表示 `bounds.origin.x` 可能是絕對座標
   - 程式使用簡化計算
   - 未來可以完全移除累積寬度邏輯

2. **如果「寬度差異」顯著（> 1.0）**：
   - 表示 `bounds.origin.x` 是相對座標
   - 程式使用累積計算
   - 維持現有邏輯是正確的

### Y 座標閾值調整

如果發現跨行檢測不準確：

1. **誤判為單行（實際跨行）**：
   - 可能閾值太大
   - 建議降低閾值（例如從 `first_height * 0.3` 改為 `0.2`）

2. **誤判為跨行（實際單行）**：
   - 可能閾值太小
   - 建議提高閾值或增加最小值（例如從 `max(50, ...)` 改為 `max(100, ...)`）

## 已知限制

1. **行中間開始的選取**：
   - 跨行檢測基於 Y 座標變化，不受選取起始位置影響
   - 跨行時假設從行首開始（X=0），可能略有偏差

2. **特殊排版**：
   - 垂直排版（vertical text）未經測試
   - 右到左排版（RTL）可能需要額外驗證

3. **editViewWidth 設定**：
   - 依賴使用者在 Preferences > Appearance 中的「Text View Width」設定
   - 如果使用者修改此設定，跨行檢測會相應調整

## 回報問題

如果發現問題，請記錄：

1. Glyphs 版本號
2. 測試場景描述
3. Console 完整輸出
4. 預期行為 vs 實際行為
5. 截圖（如果可能）

---

**測試完成後，請在 Issue #1 中回報測試結果。**
